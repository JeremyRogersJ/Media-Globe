<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Media Explorer - TV & Radio</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.98/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.98/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100%;
            height: 100vh;
        }

        /* Hide Cesium's default UI elements */
        .cesium-viewer-toolbar,
        .cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer,
        .cesium-viewer-fullscreenContainer,
        .cesium-viewer-vrContainer,
        .cesium-viewer-bottom {
            display: none !important;
        }

        .cesium-credit-logoContainer {
            display: none !important;
        }

        /* Radio Garden style fixed center circle */
        .center-target {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 120px;
            border: 3px solid #00ff88;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            box-shadow: 
                0 0 30px #00ff88,
                inset 0 0 30px rgba(0, 255, 136, 0.2);
            animation: pulse-center 3s infinite;
        }

        .center-target::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #00ff88;
        }

        .center-target.active {
            border-color: #ff0088;
            box-shadow: 
                0 0 40px #ff0088,
                inset 0 0 40px rgba(255, 0, 136, 0.2);
            width: 160px;
            height: 160px;
        }

        .center-target.active::before {
            background: #ff0088;
            box-shadow: 0 0 15px #ff0088;
        }

        @keyframes pulse-center {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 1;
            }
        }

        /* Preview bubble that appears when circle hovers over media point */
        .preview-bubble {
            position: fixed;
            top: 50%;
            left: 50%;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 15px;
            padding: 15px 20px;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -220px);
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            border: 2px solid #00ff88;
            min-width: 250px;
            text-align: center;
        }

        .preview-bubble.active {
            opacity: 1;
            transform: translate(-50%, -220px) scale(1);
        }

        .preview-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .preview-video {
            width: 200px;
            height: 112px;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: none;
        }

        .preview-logo {
            width: 80px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .preview-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .preview-subtitle {
            font-size: 12px;
            color: #888;
        }

        /* Media station list overlay (right side) */
        .media-overlay {
            position: fixed;
            top: 50%;
            right: 20px;
            width: 380px;
            max-height: 70vh;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 15px;
            border: 2px solid #00ff88;
            padding: 20px;
            z-index: 100;
            transform: translateY(-50%) translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .media-overlay.active {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .media-overlay::-webkit-scrollbar {
            width: 8px;
        }

        .media-overlay::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .media-overlay::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 4px;
        }

        .location-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .close-overlay {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-overlay:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .location-name {
            font-size: 18px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .station-count {
            font-size: 12px;
            color: #888;
        }

        .media-station {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .media-station:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ff88;
            transform: translateX(-5px);
        }

        .media-station.playing {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .media-station.tv-station:hover {
            border-color: #ff6b6b;
        }

        .media-station.tv-station.playing {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.3);
        }

        .station-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00ff88, #00cc66);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .tv-station .station-icon {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
        }

        .station-logo {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: contain;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
        }

        .station-thumbnail {
            width: 60px;
            height: 35px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
        }

        .station-info {
            flex: 1;
            min-width: 0;
        }

        .station-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .station-location {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .play-indicator {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .media-station.playing .play-indicator {
            opacity: 1;
            animation: pulse-play 1.5s infinite;
        }

        @keyframes pulse-play {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Video player for TV streams */
        #videoPlayer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            height: auto;
            z-index: 5000;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            display: none;
        }

        #videoPlayer.active {
            display: block;
        }

        /* Audio player for radio */
        #audioPlayer {
            display: none;
        }

        /* Control panel */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 20, 20, 0.9);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 280px;
            z-index: 1;
            opacity: 0;
            animation: fade-in-controls 1s ease-out 2s both;
        }

        @keyframes fade-in-controls {
            0% {
                opacity: 0;
                transform: translateX(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .controls h3 {
            margin-bottom: 15px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #888;
        }

        .platform-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 12px 15px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .platform-btn input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--platform-color);
        }

        .platform-btn.active { 
            background: linear-gradient(135deg, var(--platform-color), var(--platform-color-dark));
            border-color: var(--platform-color);
            box-shadow: 0 0 20px var(--platform-glow);
        }

        .platform-btn.radio.active { 
            --platform-color: #00ff88;
            --platform-color-dark: #00cc66;
            --platform-glow: rgba(0, 255, 136, 0.5);
        }

        .platform-btn.tv.active { 
            --platform-color: #ff6b6b;
            --platform-color-dark: #ff5252;
            --platform-glow: rgba(255, 107, 107, 0.5);
        }

        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
            opacity: 1;
            transition: opacity 1.5s ease-out;
        }

        .loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-screen h2 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            animation: pulse-text 2s ease-in-out infinite;
        }

        @keyframes pulse-text {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.02);
            }
        }

        /* API Status indicator */
        .api-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            opacity: 0;
            animation: fade-in-stats 1s ease-out 4s both;
        }

        @keyframes fade-in-stats {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .api-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            gap: 20px;
        }

        .api-item:last-child {
            margin-bottom: 0;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online { background: #22c55e; }
        .status-dot.offline { background: #ef4444; }
        .status-dot.limited { background: #f59e0b; }
        .status-dot.loading { 
            background: #f59e0b; 
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Instructions overlay */
        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9);
            padding: 15px 25px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            color: #888;
            text-align: center;
            opacity: 0;
            animation: fade-in-instructions 1s ease-out 5s both;
        }

        @keyframes fade-in-instructions {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Media Player Controls */
        .media-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95);
            border-radius: 30px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .media-controls.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .media-controls button {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-controls button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .media-controls .play-pause-btn {
            background: #00ff88;
            color: #000;
            font-size: 24px;
        }

        .media-controls .play-pause-btn.tv-playing {
            background: #ff6b6b;
        }

        .media-controls .play-pause-btn:hover {
            background: #00cc66;
            transform: scale(1.1);
        }

        .media-controls .play-pause-btn.tv-playing:hover {
            background: #ff5252;
        }

        .media-info {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }

        .media-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-location {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .volume-slider {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #00ff88;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #00ff88;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Video overlay controls */
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        #videoPlayer:hover .video-overlay {
            opacity: 1;
            pointer-events: all;
        }

        .video-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-close:hover {
            background: rgba(255, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    <!-- Radio Garden style fixed center target -->
    <div class="center-target" id="centerTarget"></div>
    
    <!-- Preview bubble for hovering media -->
    <div class="preview-bubble" id="previewBubble">
        <div class="preview-icon" id="previewIcon">📻</div>
        <video class="preview-video" id="previewVideo" muted autoplay loop></video>
        <img class="preview-logo" id="previewLogo" style="display: none;">
        <div class="preview-title" id="previewTitle">Station Name</div>
        <div class="preview-subtitle" id="previewSubtitle">Location</div>
    </div>

    <!-- Media station list (right side) -->
    <div class="media-overlay" id="mediaOverlay">
        <div class="location-header">
            <button class="close-overlay" onclick="closeMediaOverlay()">×</button>
            <div class="location-name" id="locationName">Select a location</div>
            <div class="station-count" id="stationCount">Click on stations to explore</div>
        </div>
        <div id="mediaStations">
            <!-- Media stations will be populated here -->
        </div>
    </div>

    <!-- Media Player Controls -->
    <div class="media-controls" id="mediaControls">
        <button class="prev-btn" onclick="previousStation()" title="Previous station">⏮️</button>
        <button class="play-pause-btn" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">▶️</button>
        <button class="next-btn" onclick="nextStation()" title="Next station">⏭️</button>
        <div class="media-info">
            <div class="media-name" id="mediaName">No station selected</div>
            <div class="media-location" id="mediaLocation">Click on a station</div>
        </div>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70" onchange="setVolume(this.value)">
        <button class="stop-btn" onclick="stopMedia()" title="Stop">⏹️</button>
        <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen TV">📺</button>
    </div>

    <!-- Media players -->
    <audio id="audioPlayer" preload="none" crossorigin="anonymous"></audio>
    
    <!-- Video player with overlay controls -->
    <video id="videoPlayer" preload="none" crossorigin="anonymous" controls>
        <div class="video-overlay">
            <button class="video-close" onclick="closeVideoPlayer()">×</button>
        </div>
    </video>

    <div class="loading-screen" id="loadingScreen">
        <h2>CONNECTING TO GLOBAL MEDIA</h2>
        <p style="color: #666;">Loading worldwide TV and radio sources...</p>
    </div>

    <div id="cesiumContainer"></div>

    <!-- Instructions -->
    <div class="instructions">
        🌍 Rotate globe to explore • 📻📺 Click dots to view media • 🎯 Hover for TV previews
    </div>

    <!-- API Status -->
    <div class="api-status" id="apiStatus">
        <div class="api-item">
            <span>📡 Radio Sources:</span>
            <span><span class="status-dot loading" id="radioStatus"></span> <span id="radioStatusText">Connecting...</span></span>
        </div>
        <div class="api-item">
            <span>📺 TV Channels:</span>
            <span><span class="status-dot loading" id="tvStatus"></span> <span id="tvStatusText">Loading...</span></span>
        </div>
        <div class="api-item">
            <span>🌍 Sources loaded:</span>
            <span id="stationsLoaded">0</span>
        </div>
        <div class="api-item">
            <span>📍 Cities available:</span>
            <span id="citiesLoaded">0</span>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="controls">
        <h3>MEDIA PLATFORMS</h3>
        <label class="platform-btn radio" data-platform="radio">
            <input type="checkbox" checked onchange="togglePlatform('radio', this.checked)">
            <span>📻 Radio Garden</span>
        </label>
        <label class="platform-btn tv" data-platform="tv">
            <input type="checkbox" checked onchange="togglePlatform('tv', this.checked)">
            <span>📺 TV News Channels</span>
        </label>
    </div>

    <script>
        // Set Cesium Ion access token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkNjRlOTljNi00ODQ1LTQxZDYtODIwMC01ZTJkMjQwYzdjN2QiLCJpZCI6MzE5ODE4LCJpYXQiOjE3NTIwNDA1Nzl9.DskqzfOuG7LLyrd3196kPBYTrbJ_R8Qdj6jNubBkHEE';

        let viewer;
        let countryBordersDataSource = null;
        let mediaDataSources = {};
        let radioDataSource = null;
        let tvDataSource = null;
        let radioPlaces = [];
        let tvChannels = [];
        let tvPlaces = [];
        let currentPlayingStation = null;
        let audioPlayer = null;
        let videoPlayer = null;
        let previewVideo = null;
        let currentHoveredPlace = null;
        let activePlatforms = new Set(['radio', 'tv']);
        let overlayOpenedByClick = false;
        let tvChannelsData = {};
        let tvStreamsData = {};
        let tvLogosData = {};
        let previewTimeout = null;

        // Platform configurations
        const platformConfig = {
            radio: { 
                color: Cesium.Color.fromCssColorString('#00ff88'), 
                icon: '📻', 
                name: 'Radio Garden',
                borderColor: '#00ff88'
            },
            tv: { 
                color: Cesium.Color.fromCssColorString('#ff6b6b'), 
                icon: '📺', 
                name: 'TV News',
                borderColor: '#ff6b6b'
            }
        };

        // Toggle platform visibility
        window.togglePlatform = function(platform, isActive) {
            const btn = document.querySelector(`.platform-btn.${platform}`);
            if (isActive) {
                activePlatforms.add(platform);
                btn.classList.add('active');
            } else {
                activePlatforms.delete(platform);
                btn.classList.remove('active');
            }
            
            // Show/hide media sources for this platform
            if (mediaDataSources[platform]) {
                mediaDataSources[platform].show = isActive;
            }
        };

        try {
            // Initialize Cesium viewer
            viewer = new Cesium.Viewer('cesiumContainer', {
                baseLayerPicker: false,
                geocoder: false,
                homeButton: false,
                sceneModePicker: false,
                navigationHelpButton: false,
                animation: false,
                timeline: false,
                fullscreenButton: false,
                vrButton: false,
                creditContainer: document.createElement('div')
            });

            console.log('Cesium viewer created successfully');

            // Initialize media players
            audioPlayer = document.getElementById('audioPlayer');
            videoPlayer = document.getElementById('videoPlayer');
            previewVideo = document.getElementById('previewVideo');

            // Enable lighting and set dark theme
            viewer.scene.globe.enableLighting = true;
            viewer.scene.backgroundColor = Cesium.Color.BLACK;
            viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString('#1a1a1a');
            
            // Set initial camera position
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(0, 20, 15000000)
            });
            
            // Add terrain
            viewer.terrainProvider = Cesium.createWorldTerrain();

            // Setup center targeting system
            setupCenterTargeting();

            // Load country borders
            async function loadCountryBorders() {
                try {
                    countryBordersDataSource = await Cesium.GeoJsonDataSource.load(
                        'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson',
                        { clampToGround: true }
                    );
                    
                    countryBordersDataSource.entities.values.forEach(entity => {
                        if (entity.polygon) {
                            entity.polygon.material = Cesium.Color.TRANSPARENT;
                            entity.polygon.outline = true;
                            entity.polygon.outlineColor = Cesium.Color.WHITE.withAlpha(0.3);
                            entity.polygon.outlineWidth = 1;
                            entity.polygon.height = 0;
                        }
                    });
                    
                    viewer.dataSources.add(countryBordersDataSource);
                    console.log('✅ Country borders loaded');
                } catch (error) {
                    console.warn('Failed to load country borders:', error);
                }
            }

            // Fetch IPTV TV Channels from real API
            async function fetchTVChannels() {
                try {
                    updateTVStatus('loading', 'Loading TV channels...');
                    
                    console.log('🔄 Fetching TV channels data...');
                    
                    // Fetch channels data
                    const channelsResponse = await fetch('https://iptv-org.github.io/api/channels.json');
                    const channelsData = await channelsResponse.json();
                    
                    // Fetch streams data
                    const streamsResponse = await fetch('https://iptv-org.github.io/api/streams.json');
                    const streamsData = await streamsResponse.json();
                    
                    // Fetch logos data
                    const logosResponse = await fetch('https://iptv-org.github.io/api/logos.json');
                    const logosData = await logosResponse.json();
                    
                    console.log(`📺 Loaded ${channelsData.length} total channels`);
                    
                    // Filter for news channels only
                    const newsChannels = channelsData.filter(channel => 
                        channel.categories && channel.categories.includes('news')
                    );
                    
                    console.log(`📰 Found ${newsChannels.length} news channels`);
                    
                    // Create lookup maps for better performance
                    tvStreamsData = {};
                    streamsData.forEach(stream => {
                        if (!tvStreamsData[stream.channel]) {
                            tvStreamsData[stream.channel] = [];
                        }
                        tvStreamsData[stream.channel].push(stream);
                    });
                    
                    tvLogosData = {};
                    logosData.forEach(logo => {
                        if (!tvLogosData[logo.channel]) {
                            tvLogosData[logo.channel] = [];
                        }
                        tvLogosData[logo.channel].push(logo);
                    });
                    
                    // Group channels by country/city
                    const channelsByLocation = {};
                    
                    newsChannels.forEach(channel => {
                        const country = channel.country || 'Unknown';
                        const city = channel.city || getCapitalCity(country) || country;
                        const key = `${country}-${city}`;
                        
                        if (!channelsByLocation[key]) {
                            channelsByLocation[key] = {
                                country: country,
                                city: city,
                                coordinates: getCountryCoordinates(country),
                                channels: []
                            };
                        }
                        
                        // Only add channels that have streams
                        if (tvStreamsData[channel.id] && tvStreamsData[channel.id].length > 0) {
                            channelsByLocation[key].channels.push(channel);
                        }
                    });
                    
                    // Convert to array and filter out locations with no streamable channels
                    tvPlaces = Object.values(channelsByLocation).filter(place => place.channels.length > 0);
                    
                    console.log(`🌍 Grouped into ${tvPlaces.length} locations with streamable news channels`);
                    updateTVStatus('online', 'TV channels loaded');
                    
                    // Create TV markers
                    createTVMarkers();
                    
                    return tvPlaces;
                } catch (error) {
                    console.error('Failed to fetch TV channels:', error);
                    updateTVStatus('offline', 'Failed to load TV');
                    return [];
                }
            }

            // Get country coordinates (capital city locations)
            function getCountryCoordinates(countryCode) {
                const coordinates = {
                    'US': [-77.0369, 38.9072], // Washington DC
                    'UK': [-0.1276, 51.5074], // London
                    'FR': [2.3522, 48.8566], // Paris
                    'DE': [13.4050, 52.5200], // Berlin
                    'IT': [12.4964, 41.9028], // Rome
                    'ES': [-3.7038, 40.4168], // Madrid
                    'RU': [37.6176, 55.7558], // Moscow
                    'CN': [116.4074, 39.9042], // Beijing
                    'JP': [139.6917, 35.6895], // Tokyo
                    'IN': [77.2090, 28.6139], // New Delhi
                    'BR': [-47.8825, -15.7942], // Brasília
                    'CA': [-75.6919, 45.4215], // Ottawa
                    'AU': [149.1300, -35.2809], // Canberra
                    'ZA': [28.0473, -26.2041], // Johannesburg
                    'MX': [-99.1332, 19.4326], // Mexico City
                    'AR': [-58.3816, -34.6037], // Buenos Aires
                    'EG': [31.2357, 30.0444], // Cairo
                    'SA': [46.6753, 24.7136], // Riyadh
                    'AE': [55.2708, 25.2048], // Dubai
                    'TR': [32.8597, 39.9334], // Ankara
                    'IL': [34.7818, 32.0853], // Tel Aviv
                    'IR': [51.3890, 35.6892], // Tehran
                    'IQ': [44.3661, 33.3152], // Baghdad
                    'JO': [35.9106, 31.9539], // Amman
                    'LB': [35.5018, 33.8938], // Beirut
                    'SY': [36.2765, 33.5138], // Damascus
                    'KW': [47.9774, 29.3759], // Kuwait City
                    'QA': [51.5310, 25.2854], // Doha
                    'OM': [58.4059, 23.5859], // Muscat
                    'BH': [50.5577, 26.0667], // Manama
                    'YE': [44.2075, 15.3694], // Sanaa
                    'PS': [35.2033, 31.7683], // Gaza/Ramallah
                    'AF': [69.1761, 34.5228], // Kabul
                    'PK': [73.0479, 33.6844], // Islamabad
                    'BD': [90.3563, 23.6850], // Dhaka
                    'LK': [79.8612, 6.9271], // Colombo
                    'MM': [96.1561, 16.8661], // Naypyidaw
                    'TH': [100.5018, 13.7563], // Bangkok
                    'VN': [105.8542, 21.0285], // Hanoi
                    'KH': [104.9160, 11.5564], // Phnom Penh
                    'LA': [102.6000, 17.9667], // Vientiane
                    'KR': [126.9780, 37.5665], // Seoul
                    'KP': [125.7625, 39.0392], // Pyongyang
                    'MN': [106.8832, 47.8864], // Ulaanbaatar
                    'KZ': [71.4687, 51.1605], // Nur-Sultan
                    'UZ': [69.2787, 41.2995], // Tashkent
                    'KG': [74.5698, 42.8746], // Bishkek
                    'TJ': [68.7864, 38.5610], // Dushanbe
                    'TM': [58.3794, 37.9601], // Ashgabat
                    'AZ': [49.8671, 40.4093], // Baku
                    'AM': [44.5152, 40.1792], // Yerevan
                    'GE': [44.7873, 41.7151], // Tbilisi
                    'BY': [27.5766, 53.9045], // Minsk
                    'UA': [30.5234, 50.4501], // Kyiv
                    'MD': [28.8497, 47.0105], // Chisinau
                    'RO': [26.1025, 44.4268], // Bucharest
                    'BG': [23.3219, 42.6977], // Sofia
                    'GR': [23.7275, 37.9838], // Athens
                    'AL': [19.8187, 41.3275], // Tirana
                    'MK': [21.4254, 41.9981], // Skopje
                    'ME': [19.2636, 42.4304], // Podgorica
                    'RS': [20.4612, 44.7866], // Belgrade
                    'BA': [18.4131, 43.8563], // Sarajevo
                    'HR': [15.9819, 45.8150], // Zagreb
                    'SI': [14.5058, 46.0569], // Ljubljana
                    'SK': [17.1077, 48.1486], // Bratislava
                    'CZ': [14.4378, 50.0755], // Prague
                    'PL': [21.0122, 52.2297], // Warsaw
                    'HU': [19.0402, 47.4979], // Budapest
                    'AT': [16.3738, 48.2082], // Vienna
                    'CH': [7.4474, 46.9480], // Bern
                    'LI': [9.5215, 47.1410], // Vaduz
                    'LU': [6.1296, 49.8118], // Luxembourg
                    'BE': [4.3517, 50.8503], // Brussels
                    'NL': [4.9041, 52.3676], // Amsterdam
                    'DK': [12.5683, 55.6761], // Copenhagen
                    'SE': [18.0686, 59.3293], // Stockholm
                    'NO': [10.7522, 59.9139], // Oslo
                    'FI': [24.9384, 60.1695], // Helsinki
                    'IS': [-21.8174, 64.1466], // Reykjavik
                    'IE': [-6.2603, 53.3498], // Dublin
                    'PT': [-9.1393, 38.7223], // Lisbon
                    'MA': [-6.8498, 34.0209], // Rabat
                    'DZ': [3.2097, 36.7538], // Algiers
                    'TN': [10.1815, 36.8065], // Tunis
                    'LY': [13.1913, 32.8872], // Tripoli
                    'SD': [32.5599, 15.5007], // Khartoum
                    'ET': [38.7469, 9.1450], // Addis Ababa
                    'KE': [36.8219, -1.2921], // Nairobi
                    'UG': [32.5825, 0.3476], // Kampala
                    'TZ': [35.7382, -6.7924], // Dodoma
                    'RW': [30.0588, -1.9441], // Kigali
                    'BI': [29.3644, -3.3761], // Gitega
                    'CD': [15.3137, -4.3276], // Kinshasa
                    'CG': [15.2662, -4.2634], // Brazzaville
                    'CM': [11.5174, 3.8480], // Yaoundé
                    'CF': [18.5582, 4.3947], // Bangui
                    'TD': [15.0444, 12.1348], // N'Djamena
                    'NE': [2.1111, 13.5116], // Niamey
                    'NG': [7.5399, 9.0579], // Abuja
                    'BJ': [2.3158, 6.4969], // Porto-Novo
                    'TG': [1.2255, 6.1228], // Lomé
                    'GH': [-0.1969, 5.6037], // Accra
                    'CI': [-5.5471, 7.5400], // Yamoussoukro
                    'LR': [-10.7969, 6.2907], // Monrovia
                    'SL': [-13.2317, 8.4657], // Freetown
                    'GN': [-13.7122, 9.6412], // Conakry
                    'GW': [-15.1804, 11.8037], // Bissau
                    'SN': [-17.4441, 14.7167], // Dakar
                    'GM': [-16.5775, 13.4432], // Banjul
                    'ML': [-7.9926, 12.6392], // Bamako
                    'BF': [-1.5616, 12.2383], // Ouagadougou
                    'MR': [-15.9582, 18.0735], // Nouakchott
                    'DV': [73.5093, 4.1755] // Malé (Maldives)
                };
                
                return coordinates[countryCode] || [0, 0]; // Default to [0, 0] if country not found
            }

            // Get capital city name for a country
            function getCapitalCity(countryCode) {
                const capitals = {
                    'US': 'Washington DC',
                    'UK': 'London',
                    'FR': 'Paris',
                    'DE': 'Berlin',
                    'IT': 'Rome',
                    'ES': 'Madrid',
                    'RU': 'Moscow',
                    'CN': 'Beijing',
                    'JP': 'Tokyo',
                    'IN': 'New Delhi',
                    'BR': 'Brasília',
                    'CA': 'Ottawa',
                    'AU': 'Canberra',
                    'ZA': 'Johannesburg',
                    'MX': 'Mexico City',
                    'AR': 'Buenos Aires',
                    'EG': 'Cairo',
                    'SA': 'Riyadh',
                    'AE': 'Dubai',
                    'TR': 'Ankara'
                };
                
                return capitals[countryCode] || countryCode;
            }

            // Create TV markers on the globe
            function createTVMarkers() {
                tvDataSource = new Cesium.CustomDataSource('tv-channels');
                mediaDataSources['tv'] = tvDataSource;
                viewer.dataSources.add(tvDataSource);
                
                const config = platformConfig.tv;
                let totalChannels = 0;

                tvPlaces.forEach(place => {
                    const numChannels = place.channels.length;
                    totalChannels += numChannels;
                    
                    const [lon, lat] = place.coordinates;
                    
                    // Create entity for the TV station cluster
                    const entity = tvDataSource.entities.add({
                        id: `tv_${place.country}_${place.city}`,
                        position: Cesium.Cartesian3.fromDegrees(lon, lat),
                        point: {
                            pixelSize: Math.min(numChannels * 2 + 12, 25),
                            color: config.color,
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2,
                            scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 1.5e7, 0.8),
                            translucencyByDistance: new Cesium.NearFarScalar(1.5e2, 1.0, 1.5e7, 0.5),
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        },
                        label: {
                            text: config.icon,
                            font: '18px Arial',
                            pixelOffset: new Cesium.Cartesian2(0, -35),
                            fillColor: Cesium.Color.WHITE,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            scaleByDistance: new Cesium.NearFarScalar(1.5e2, 1.2, 1.5e7, 0.5),
                            disableDepthTestDistance: Number.POSITIVE_INFINITY
                        },
                        properties: {
                            ...place,
                            platform: 'tv',
                            size: numChannels
                        }
                    });
                    
                    // Add pulsing effect on hover
                    entity.point.pixelSize = new Cesium.CallbackProperty(function() {
                        if (currentHoveredPlace && 
                            currentHoveredPlace.place === place && 
                            currentHoveredPlace.platform === 'tv') {
                            return Math.min(numChannels * 2 + 18, 30); // Larger when hovered
                        }
                        return Math.min(numChannels * 2 + 12, 25);
                    }, false);
                });

                console.log(`✅ Created ${tvPlaces.length} TV location markers with ${totalChannels} total news channels`);
                
                // Update UI counters
                updateStationCounts();
            }

            // Setup center targeting system like Radio Garden
            function setupCenterTargeting() {
                const centerTarget = document.getElementById('centerTarget');
                const previewBubble = document.getElementById('previewBubble');

                // Check center area when camera moves
                viewer.scene.camera.moveEnd.addEventListener(() => {
                    checkCenterArea();
                });

                // Also check periodically
                setInterval(checkCenterArea, 100);
            }

            // Check what media sources are in the center of the screen
            function checkCenterArea() {
                const centerTarget = document.getElementById('centerTarget');
                const previewBubble = document.getElementById('previewBubble');
                
                // Get center position
                const canvas = viewer.scene.canvas;
                const centerX = canvas.clientWidth / 2;
                const centerY = canvas.clientHeight / 2;

                const pickedPosition = viewer.camera.pickEllipsoid(
                    new Cesium.Cartesian2(centerX, centerY),
                    viewer.scene.globe.ellipsoid
                );

                if (!pickedPosition) return;

                const cartographic = Cesium.Cartographic.fromCartesian(pickedPosition);
                const longitude = Cesium.Math.toDegrees(cartographic.longitude);
                const latitude = Cesium.Math.toDegrees(cartographic.latitude);

                // Find nearby stations
                const cameraHeight = viewer.camera.positionCartographic.height;
                const searchRadius = Math.min(cameraHeight / 100000, 5);
                
                let nearestStation = null;
                let nearestDistance = Infinity;
                let nearestPlatform = null;
                
                // Check radio stations
                if (activePlatforms.has('radio') && radioDataSource) {
                    radioDataSource.entities.values.forEach(entity => {
                        if (!entity.position || !entity.properties) return;
                        
                        const props = entity.properties.getValue();
                        if (!props.isStation) return;
                        
                        const position = entity.position.getValue();
                        const cartographic = Cesium.Cartographic.fromCartesian(position);
                        const entityLon = Cesium.Math.toDegrees(cartographic.longitude);
                        const entityLat = Cesium.Math.toDegrees(cartographic.latitude);
                        
                        const distance = Math.sqrt(
                            Math.pow(entityLat - latitude, 2) + 
                            Math.pow(entityLon - longitude, 2)
                        );
                        
                        if (distance < searchRadius && distance < nearestDistance) {
                            nearestDistance = distance;
                            nearestStation = props;
                            nearestPlatform = 'radio';
                        }
                    });
                }
                
                // Check TV stations
                if (activePlatforms.has('tv') && tvDataSource) {
                    tvDataSource.entities.values.forEach(entity => {
                        if (!entity.position || !entity.properties) return;
                        
                        const props = entity.properties.getValue();
                        const position = entity.position.getValue();
                        const cartographic = Cesium.Cartographic.fromCartesian(position);
                        const entityLon = Cesium.Math.toDegrees(cartographic.longitude);
                        const entityLat = Cesium.Math.toDegrees(cartographic.latitude);
                        
                        const distance = Math.sqrt(
                            Math.pow(entityLat - latitude, 2) + 
                            Math.pow(entityLon - longitude, 2)
                        );
                        
                        if (distance < searchRadius && distance < nearestDistance) {
                            nearestDistance = distance;
                            nearestStation = props;
                            nearestPlatform = 'tv';
                        }
                    });
                }

                if (nearestStation && nearestPlatform) {
                    centerTarget.classList.add('active');
                    centerTarget.style.borderColor = platformConfig[nearestPlatform].borderColor;
                    centerTarget.style.boxShadow = `0 0 40px ${platformConfig[nearestPlatform].borderColor}, inset 0 0 40px ${platformConfig[nearestPlatform].borderColor}33`;
                    
                    // Show appropriate preview
                    if (nearestStation.isStation) {
                        showStationPreview(nearestStation);
                        currentHoveredPlace = { station: nearestStation.station, place: nearestStation, platform: nearestPlatform };
                    } else {
                        showPreview(nearestStation, nearestPlatform);
                        currentHoveredPlace = { place: nearestStation, platform: nearestPlatform };
                    }
                } else {
                    centerTarget.classList.remove('active');
                    centerTarget.style.borderColor = '#00ff88';
                    centerTarget.style.boxShadow = '0 0 30px #00ff88, inset 0 0 30px rgba(0, 255, 136, 0.2)';
                    
                    previewBubble.classList.remove('active');
                    stopVideoPreview();
                    currentHoveredPlace = null;
                }
            }

            // Show preview bubble with video thumbnail for TV
            function showPreview(place, platform) {
                const previewBubble = document.getElementById('previewBubble');
                const previewIcon = document.getElementById('previewIcon');
                const previewLogo = document.getElementById('previewLogo');
                const previewVideo = document.getElementById('previewVideo');
                const previewTitle = document.getElementById('previewTitle');
                const previewSubtitle = document.getElementById('previewSubtitle');
                
                const config = platformConfig[platform];
                
                // Reset displays
                previewIcon.style.display = 'block';
                previewLogo.style.display = 'none';
                previewVideo.style.display = 'none';
                
                previewIcon.textContent = config.icon;
                previewTitle.textContent = place.city || place.title;
                
                if (platform === 'tv' && place.channels && place.channels.length > 0) {
                    // Try to show logo and video preview of first available channel
                    const firstChannel = place.channels[0];
                    const logos = tvLogosData[firstChannel.id];
                    const streams = tvStreamsData[firstChannel.id];
                    
                    if (logos && logos.length > 0) {
                        previewLogo.src = logos[0].url;
                        previewLogo.style.display = 'block';
                        previewIcon.style.display = 'none';
                    }
                    
                    // Show video preview if stream available
                    if (streams && streams.length > 0) {
                        startVideoPreview(streams[0].url);
                    }
                    
                    previewSubtitle.textContent = `${place.country} • ${place.size || place.channels.length} news channels`;
                } else {
                    previewSubtitle.textContent = `${place.country} • ${place.size} ${platform} sources`;
                }
                
                previewBubble.style.borderColor = config.borderColor;
                previewBubble.classList.add('active');
            }

            // Start video preview
            function startVideoPreview(streamUrl) {
                if (previewTimeout) {
                    clearTimeout(previewTimeout);
                }
                
                // Delay video loading to avoid too many requests
                previewTimeout = setTimeout(() => {
                    try {
                        const previewVideo = document.getElementById('previewVideo');
                        previewVideo.src = streamUrl;
                        previewVideo.muted = true;
                        previewVideo.autoplay = true;
                        previewVideo.style.display = 'block';
                        
                        // Hide icon/logo when video loads
                        previewVideo.addEventListener('loadeddata', () => {
                            document.getElementById('previewIcon').style.display = 'none';
                            document.getElementById('previewLogo').style.display = 'none';
                        });
                        
                        // Fallback if video fails
                        previewVideo.addEventListener('error', () => {
                            previewVideo.style.display = 'none';
                            document.getElementById('previewIcon').style.display = 'block';
                        });
                        
                    } catch (error) {
                        console.warn('Preview video failed:', error);
                    }
                }, 500); // 500ms delay
            }

            // Stop video preview
            function stopVideoPreview() {
                if (previewTimeout) {
                    clearTimeout(previewTimeout);
                }
                
                const previewVideo = document.getElementById('previewVideo');
                if (previewVideo.src) {
                    previewVideo.pause();
                    previewVideo.src = '';
                    previewVideo.style.display = 'none';
                }
            }
            
            // Show preview for individual station
            function showStationPreview(stationData) {
                const previewBubble = document.getElementById('previewBubble');
                const previewIcon = document.getElementById('previewIcon');
                const previewLogo = document.getElementById('previewLogo');
                const previewVideo = document.getElementById('previewVideo');
                const previewTitle = document.getElementById('previewTitle');
                const previewSubtitle = document.getElementById('previewSubtitle');
                
                // Reset for radio
                previewIcon.textContent = '📻';
                previewIcon.style.display = 'block';
                previewLogo.style.display = 'none';
                previewVideo.style.display = 'none';
                
                previewTitle.textContent = stationData.station.title;
                previewSubtitle.textContent = `${stationData.title}, ${stationData.country}`;
                
                previewBubble.style.borderColor = platformConfig.radio.borderColor;
                previewBubble.classList.add('active');
            }

            // Get demo data for Radio Garden places
            function getRadioPlacesDemo() {
                return [
                    // Major cities with radio stations
                    { id: 'london', geo: [-0.1278, 51.5074], title: 'London', country: 'United Kingdom', size: 45 },
                    { id: 'newyork', geo: [-74.0060, 40.7128], title: 'New York', country: 'United States', size: 38 },
                    { id: 'paris', geo: [2.3522, 48.8566], title: 'Paris', country: 'France', size: 32 },
                    { id: 'tokyo', geo: [139.6503, 35.6762], title: 'Tokyo', country: 'Japan', size: 45 },
                    { id: 'sydney', geo: [151.2093, -33.8688], title: 'Sydney', country: 'Australia', size: 24 },
                    { id: 'berlin', geo: [13.4050, 52.5200], title: 'Berlin', country: 'Germany', size: 22 },
                    { id: 'moscow', geo: [37.6176, 55.7558], title: 'Moscow', country: 'Russia', size: 26 },
                    { id: 'losangeles', geo: [-118.2437, 34.0522], title: 'Los Angeles', country: 'United States', size: 35 },
                    { id: 'madrid', geo: [-3.7038, 40.4168], title: 'Madrid', country: 'Spain', size: 20 },
                    { id: 'rome', geo: [12.4964, 41.9028], title: 'Rome', country: 'Italy', size: 18 },
                    { id: 'mumbai', geo: [72.8777, 19.0760], title: 'Mumbai', country: 'India', size: 30 },
                    { id: 'beijing', geo: [116.4074, 39.9042], title: 'Beijing', country: 'China', size: 25 },
                    { id: 'cairo', geo: [31.2357, 30.0444], title: 'Cairo', country: 'Egypt', size: 15 },
                    { id: 'capetown', geo: [18.4241, -33.9249], title: 'Cape Town', country: 'South Africa', size: 12 },
                    { id: 'toronto', geo: [-79.3832, 43.6532], title: 'Toronto', country: 'Canada', size: 25 },
                    { id: 'amsterdam', geo: [4.9041, 52.3676], title: 'Amsterdam', country: 'Netherlands', size: 20 },
                    { id: 'stockholm', geo: [18.0686, 59.3293], title: 'Stockholm', country: 'Sweden', size: 16 },
                    { id: 'dubai', geo: [55.2708, 25.2048], title: 'Dubai', country: 'UAE', size: 18 },
                    { id: 'saopaulo', geo: [-46.6333, -23.5505], title: 'São Paulo', country: 'Brazil', size: 28 },
                    { id: 'bangkok', geo: [100.5018, 13.7563], title: 'Bangkok', country: 'Thailand', size: 22 }
                ];
            }
            
            // Fetch radio places and create individual station markers
            async function fetchRadioPlaces() {
                try {
                    updateRadioStatus('loading', 'Loading radio stations...');
                    
                    // Get radio places
                    radioPlaces = getRadioPlacesDemo();
                    
                    console.log(`✅ Loaded ${radioPlaces.length} radio cities`);
                    updateRadioStatus('online', 'Connected');
                    
                    // Create individual station markers
                    createIndividualStationMarkers();
                    
                    return radioPlaces;
                } catch (error) {
                    console.error('Failed to fetch radio places:', error);
                    updateRadioStatus('offline', 'Using demo data');
                    radioPlaces = getRadioPlacesDemo();
                    createIndividualStationMarkers();
                    return radioPlaces;
                }
            }

            // Create individual station markers (like Radio Garden)
            function createIndividualStationMarkers() {
                radioDataSource = new Cesium.CustomDataSource('radio-stations');
                mediaDataSources['radio'] = radioDataSource;
                viewer.dataSources.add(radioDataSource);
                
                const config = platformConfig.radio;
                let totalStations = 0;

                radioPlaces.forEach(place => {
                    const stations = getDemoStationsForPlace(place);
                    const numStations = stations.length;
                    totalStations += numStations;
                    
                    // Calculate spread pattern for stations
                    const baseRadius = 0.05; // Base spread radius in degrees
                    const radiusMultiplier = Math.min(numStations / 20, 2); // Scale with number of stations
                    const spreadRadius = baseRadius * radiusMultiplier;
                    
                    // Create Fibonacci spiral pattern for natural distribution
                    const goldenAngle = Math.PI * (3 - Math.sqrt(5)); // Golden angle in radians
                    
                    stations.forEach((station, index) => {
                        // Fibonacci spiral distribution
                        const angle = index * goldenAngle;
                        const radius = spreadRadius * Math.sqrt(index / numStations);
                        
                        // Add some randomness for more natural look
                        const randomOffset = (Math.random() - 0.5) * 0.01;
                        const latOffset = radius * Math.sin(angle) + randomOffset;
                        const lonOffset = radius * Math.cos(angle) + randomOffset;
                        
                        const stationLon = place.geo[0] + lonOffset;
                        const stationLat = place.geo[1] + latOffset;
                        
                        // Create individual station entity
                        const entity = radioDataSource.entities.add({
                            id: `radio_${place.id}_station_${index}`,
                            position: Cesium.Cartesian3.fromDegrees(stationLon, stationLat),
                            point: {
                                pixelSize: 8,
                                color: config.color,
                                outlineColor: Cesium.Color.WHITE.withAlpha(0.8),
                                outlineWidth: 1,
                                scaleByDistance: new Cesium.NearFarScalar(1.5e2, 1.2, 1.5e7, 0.3),
                                translucencyByDistance: new Cesium.NearFarScalar(1.5e2, 1.0, 1.5e7, 0.2),
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            },
                            properties: {
                                ...place,
                                station: station,
                                stationIndex: index,
                                isStation: true,
                                platform: 'radio'
                            }
                        });
                        
                        // Add subtle pulsing effect on hover
                        entity.point.pixelSize = new Cesium.CallbackProperty(function() {
                            if (currentHoveredPlace && 
                                currentHoveredPlace.station === station) {
                                return 12; // Larger when hovered
                            }
                            return 8;
                        }, false);
                    });
                    
                    // Add city label (only visible when zoomed out)
                    radioDataSource.entities.add({
                        id: `radio_${place.id}_label`,
                        position: Cesium.Cartesian3.fromDegrees(place.geo[0], place.geo[1]),
                        label: {
                            text: place.title,
                            font: '12px Arial',
                            fillColor: Cesium.Color.WHITE.withAlpha(0.8),
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            pixelOffset: new Cesium.Cartesian2(0, -20),
                            scaleByDistance: new Cesium.NearFarScalar(5e4, 1.0, 5e5, 0),
                            disableDepthTestDistance: Number.POSITIVE_INFINITY
                        }
                    });
                });

                updateStationCounts();
                console.log(`✅ Created ${totalStations} individual radio station dots`);
            }

            // Update status indicator
            function updateRadioStatus(status, text) {
                const statusDot = document.getElementById('radioStatus');
                const statusText = document.getElementById('radioStatusText');
                
                statusDot.className = `status-dot ${status}`;
                statusText.textContent = text;
            }

            function updateTVStatus(status, text) {
                const statusDot = document.getElementById('tvStatus');
                const statusText = document.getElementById('tvStatusText');
                
                statusDot.className = `status-dot ${status}`;
                statusText.textContent = text;
            }

            function updateStationCounts() {
                const radioCount = radioPlaces.reduce((sum, place) => sum + place.size, 0);
                const tvCount = tvPlaces.reduce((sum, place) => sum + place.channels.length, 0);
                const totalCities = radioPlaces.length + tvPlaces.length;
                
                document.getElementById('stationsLoaded').textContent = radioCount + tvCount;
                document.getElementById('citiesLoaded').textContent = totalCities;
            }

            // Handle entity selection (clicking on dots)
            viewer.selectedEntityChanged.addEventListener(() => {
                const selectedEntity = viewer.selectedEntity;
                if (selectedEntity && selectedEntity.properties) {
                    const props = selectedEntity.properties.getValue();
                    if (props && props.platform) {
                        console.log(`Selected ${props.platform} source in ${props.title || props.city}`);
                        
                        if (props.platform === 'radio' && props.isStation) {
                            // Individual radio station clicked
                            overlayOpenedByClick = true;
                            showMediaStations(props, 'radio', true);
                            
                            // Auto-play the clicked station after list loads
                            setTimeout(() => {
                                const stationElements = document.querySelectorAll('.media-station');
                                if (stationElements[props.stationIndex]) {
                                    stationElements[props.stationIndex].click();
                                }
                            }, 300);
                        } else if (props.platform === 'radio') {
                            // Radio city clicked
                            overlayOpenedByClick = true;
                            showMediaStations(props, 'radio', true);
                        } else if (props.platform === 'tv') {
                            // TV location clicked
                            overlayOpenedByClick = true;
                            showMediaStations(props, 'tv', true);
                        }
                    }
                }
            });

            // Show stations for a place
            async function showMediaStations(place, platform, openedByClick = true) {
                overlayOpenedByClick = true;
                
                const mediaOverlay = document.getElementById('mediaOverlay');
                const locationName = document.getElementById('locationName');
                const stationCount = document.getElementById('stationCount');
                const mediaStationsContainer = document.getElementById('mediaStations');

                locationName.textContent = place.city || place.title;
                mediaStationsContainer.innerHTML = '';
                mediaOverlay.classList.add('active');

                if (platform === 'radio') {
                    stationCount.textContent = `Loading ${place.size} radio stations...`;
                    
                    try {
                        const stations = getDemoStationsForPlace(place);
                        stationCount.textContent = `${stations.length} radio stations`;
                        
                        stations.forEach((station, index) => {
                            const stationElement = document.createElement('div');
                            stationElement.className = 'media-station';
                            stationElement.setAttribute('data-station-index', index);
                            
                            stationElement.innerHTML = `
                                <div class="station-icon">📻</div>
                                <div class="station-info">
                                    <div class="station-name">${station.title}</div>
                                    <div class="station-location">${place.title}, ${place.country}</div>
                                </div>
                                <div class="play-indicator">🎵</div>
                            `;
                            
                            stationElement.addEventListener('click', function() {
                                playRadioStation(station, place, this);
                            });
                            
                            mediaStationsContainer.appendChild(stationElement);
                        });
                    } catch (error) {
                        stationCount.textContent = 'Failed to load radio stations';
                        console.error('Error loading radio stations:', error);
                    }
                } else if (platform === 'tv') {
                    const channels = place.channels || [];
                    stationCount.textContent = `Loading ${channels.length} TV news channels...`;
                    
                    try {
                        stationCount.textContent = `${channels.length} TV news channels`;
                        
                        channels.forEach((channel, index) => {
                            const stationElement = document.createElement('div');
                            stationElement.className = 'media-station tv-station';
                            stationElement.setAttribute('data-station-index', index);
                            
                            // Get channel logo if available
                            const logos = tvLogosData[channel.id];
                            const logoUrl = logos && logos.length > 0 ? logos[0].url : null;
                            
                            // Get stream for thumbnail
                            const streams = tvStreamsData[channel.id];
                            const streamUrl = streams && streams.length > 0 ? streams[0].url : null;
                            
                            let iconHtml;
                            if (logoUrl) {
                                iconHtml = `<img class="station-logo" src="${logoUrl}" alt="${channel.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                           <div class="station-icon" style="display: none;">📺</div>`;
                            } else if (streamUrl) {
                                iconHtml = `<video class="station-thumbnail" src="${streamUrl}" muted autoplay loop oncanplay="this.style.display='block';" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                           <div class="station-icon">📺</div>`;
                            } else {
                                iconHtml = `<div class="station-icon">📺</div>`;
                            }
                            
                            stationElement.innerHTML = `
                                ${iconHtml}
                                <div class="station-info">
                                    <div class="station-name">${channel.name}</div>
                                    <div class="station-location">${place.city}, ${place.country}</div>
                                </div>
                                <div class="play-indicator">📺</div>
                            `;
                            
                            stationElement.addEventListener('click', function() {
                                playTVChannel(channel, place, this);
                            });
                            
                            mediaStationsContainer.appendChild(stationElement);
                        });
                    } catch (error) {
                        stationCount.textContent = 'Failed to load TV channels';
                        console.error('Error loading TV channels:', error);
                    }
                }
            }

            // Play a TV channel
            function playTVChannel(channel, place, element) {
                console.log('Playing TV channel:', channel.name);
                
                try {
                    // Stop current media if playing
                    if (currentPlayingStation && currentPlayingStation.element) {
                        currentPlayingStation.element.classList.remove('playing');
                    }
                    
                    // Stop both audio and video
                    if (audioPlayer.src) {
                        audioPlayer.pause();
                        audioPlayer.src = '';
                    }
                    if (videoPlayer.src) {
                        videoPlayer.pause();
                        videoPlayer.src = '';
                    }
                    
                    // Get stream URL for this channel
                    const streams = tvStreamsData[channel.id];
                    if (!streams || streams.length === 0) {
                        console.error('No streams found for channel:', channel.id);
                        alert('No stream available for this channel');
                        return;
                    }
                    
                    // Use the first available stream
                    const stream = streams[0];
                    const streamUrl = stream.url;
                    
                    console.log(`🎬 Playing TV stream: ${streamUrl}`);
                    
                    // Set up video player for TV
                    videoPlayer.src = streamUrl;
                    videoPlayer.load();
                    
                    // Show video player
                    videoPlayer.classList.add('active');
                    
                    // Attempt to play
                    videoPlayer.play().then(() => {
                        console.log(`📺 Playing TV stream: ${streamUrl}`);
                    }).catch(error => {
                        console.log('TV playback failed:', error);
                        // Try with audio player as fallback
                        audioPlayer.src = streamUrl;
                        audioPlayer.load();
                        audioPlayer.play().catch(err => {
                            console.log('Audio fallback also failed:', err);
                        });
                    });
                    
                    // Update UI
                    currentPlayingStation = { channel, place, element, platform: 'tv' };
                    
                    // Remove playing class from all stations
                    document.querySelectorAll('.media-station').forEach(el => {
                        el.classList.remove('playing');
                    });
                    
                    // Add playing class to current station
                    element.classList.add('playing');
                    
                    // Update media controls
                    updateMediaControls(channel, place, 'tv');
                    
                } catch (error) {
                    console.error('Error in playTVChannel:', error);
                    element.classList.add('playing');
                    updateMediaControls(channel, place, 'tv');
                }
            }

            // Play a radio station
            function playRadioStation(station, place, element) {
                console.log('Playing radio station:', station.title);
                
                try {
                    // Stop current media if playing
                    if (currentPlayingStation && currentPlayingStation.element) {
                        currentPlayingStation.element.classList.remove('playing');
                    }

                    // Stop both audio and video
                    if (audioPlayer.src) {
                        audioPlayer.pause();
                        audioPlayer.src = '';
                    }
                    if (videoPlayer.src) {
                        videoPlayer.pause();
                        videoPlayer.src = '';
                        videoPlayer.classList.remove('active');
                    }
                    
                    // Demo streams that work better with CORS
                    const demoStreamUrls = [
                        'https://stream.zeno.fm/f3wvbbqmdg8uv', // Pop music stream
                        'https://live.wostreaming.net/direct/ppm-jazz24mp3-ibc1', // Jazz stream
                        'https://ice55.securenetsystems.net/DASH89', // Classic hits
                        'https://kathy.torontocast.com:1825/stream', // Easy listening
                        'https://icecast.radiofrance.fr/franceculture-lofi.mp3' // France Culture
                    ];
                    
                    const streamUrl = demoStreamUrls[Math.floor(Math.random() * demoStreamUrls.length)];
                    
                    // Set up audio player for radio
                    audioPlayer.src = streamUrl;
                    audioPlayer.load();
                    
                    // Attempt to play
                    audioPlayer.play().then(() => {
                        console.log(`🎵 Playing radio stream: ${streamUrl}`);
                    }).catch(error => {
                        console.log('Radio playback failed:', error);
                    });
                    
                    // Update UI
                    currentPlayingStation = { station, place, element, platform: 'radio' };
                    
                    // Remove playing class from all stations
                    document.querySelectorAll('.media-station').forEach(el => {
                        el.classList.remove('playing');
                    });
                    
                    // Add playing class to current station
                    element.classList.add('playing');
                    
                    // Update media controls
                    updateMediaControls(station, place, 'radio');
                    
                } catch (error) {
                    console.error('Error in playRadioStation:', error);
                    element.classList.add('playing');
                    updateMediaControls(station, place, 'radio');
                }
            }

            // Stop media playback
            window.stopMedia = function() {
                if (audioPlayer) {
                    audioPlayer.pause();
                    audioPlayer.src = '';
                }
                
                if (videoPlayer) {
                    videoPlayer.pause();
                    videoPlayer.src = '';
                    videoPlayer.classList.remove('active');
                }
                
                if (currentPlayingStation && currentPlayingStation.element) {
                    currentPlayingStation.element.classList.remove('playing');
                }
                
                currentPlayingStation = null;
                
                const mediaControls = document.getElementById('mediaControls');
                mediaControls.classList.remove('active');
                
                // Reset play button
                const playPauseBtn = document.getElementById('playPauseBtn');
                playPauseBtn.textContent = '▶️';
                playPauseBtn.classList.remove('tv-playing');
            };

            // Close video player
            window.closeVideoPlayer = function() {
                videoPlayer.pause();
                videoPlayer.src = '';
                videoPlayer.classList.remove('active');
            };

            // Toggle fullscreen
            window.toggleFullscreen = function() {
                if (currentPlayingStation && currentPlayingStation.platform === 'tv') {
                    if (videoPlayer.requestFullscreen) {
                        videoPlayer.requestFullscreen();
                    } else if (videoPlayer.webkitRequestFullscreen) {
                        videoPlayer.webkitRequestFullscreen();
                    } else if (videoPlayer.msRequestFullscreen) {
                        videoPlayer.msRequestFullscreen();
                    }
                }
            };

            // Close media overlay function
            window.closeMediaOverlay = function() {
                const mediaOverlay = document.getElementById('mediaOverlay');
                mediaOverlay.classList.remove('active');
                overlayOpenedByClick = false;
            };

            // Get demo stations for a place
            function getDemoStationsForPlace(place) {
                const stationTemplates = [
                    { name: 'FM', frequency: '98.5', genre: 'Pop' },
                    { name: 'Radio', frequency: '101.1', genre: 'Rock' },
                    { name: 'News', frequency: '88.9', genre: 'News' },
                    { name: 'Jazz', frequency: '95.7', genre: 'Jazz' },
                    { name: 'Classical', frequency: '103.3', genre: 'Classical' },
                    { name: 'Talk', frequency: '740', genre: 'Talk' },
                    { name: 'Music', frequency: '107.9', genre: 'Mixed' }
                ];

                const stations = [];
                const numStations = place.size || 5;
                
                for (let i = 0; i < numStations; i++) {
                    const template = stationTemplates[i % stationTemplates.length];
                    stations.push({
                        title: `${place.title} ${template.name} ${template.frequency}`,
                        href: `/listen/${place.title.toLowerCase().replace(/\s+/g, '-')}-${template.name.toLowerCase()}/demo${i}`,
                        genre: template.genre,
                        frequency: template.frequency
                    });
                }
                
                return stations;
            }

            // Media control functions
            function updateMediaControls(item, place, platform) {
                const mediaControls = document.getElementById('mediaControls');
                const mediaName = document.getElementById('mediaName');
                const mediaLocation = document.getElementById('mediaLocation');
                const playPauseBtn = document.getElementById('playPauseBtn');
                
                if (platform === 'tv') {
                    mediaName.textContent = item.name;
                    playPauseBtn.classList.add('tv-playing');
                } else {
                    mediaName.textContent = item.title;
                    playPauseBtn.classList.remove('tv-playing');
                }
                
                mediaLocation.textContent = `${place.city || place.title}, ${place.country}`;
                mediaControls.classList.add('active');
                
                // Update play/pause button
                const currentPlayer = platform === 'tv' ? videoPlayer : audioPlayer;
                if (currentPlayer && !currentPlayer.paused) {
                    playPauseBtn.textContent = '⏸️';
                } else {
                    playPauseBtn.textContent = '▶️';
                }
            }
            
            window.togglePlayPause = function() {
                if (!currentPlayingStation) return;
                
                const platform = currentPlayingStation.platform;
                const currentPlayer = platform === 'tv' ? videoPlayer : audioPlayer;
                const playPauseBtn = document.getElementById('playPauseBtn');
                
                if (currentPlayer.paused) {
                    currentPlayer.play().then(() => {
                        playPauseBtn.textContent = '⏸️';
                    }).catch(error => {
                        console.log('Play failed:', error);
                    });
                } else {
                    currentPlayer.pause();
                    playPauseBtn.textContent = '▶️';
                }
            };
            
            window.setVolume = function(value) {
                const volume = value / 100;
                if (audioPlayer) {
                    audioPlayer.volume = volume;
                }
                if (videoPlayer) {
                    videoPlayer.volume = volume;
                }
            };
            
            window.previousStation = function() {
                // Find previous station in the list
                const stations = document.querySelectorAll('.media-station');
                const currentIndex = Array.from(stations).findIndex(s => s.classList.contains('playing'));
                
                if (currentIndex > 0) {
                    stations[currentIndex - 1].click();
                } else if (stations.length > 0) {
                    stations[stations.length - 1].click();
                }
            };
            
            window.nextStation = function() {
                // Find next station in the list
                const stations = document.querySelectorAll('.media-station');
                const currentIndex = Array.from(stations).findIndex(s => s.classList.contains('playing'));
                
                if (currentIndex < stations.length - 1 && currentIndex >= 0) {
                    stations[currentIndex + 1].click();
                } else if (stations.length > 0) {
                    stations[0].click();
                }
            };
            
            // Set initial volume
            if (audioPlayer) {
                audioPlayer.volume = 0.7;
            }
            if (videoPlayer) {
                videoPlayer.volume = 0.7;
            }

            // Initialize everything
            setTimeout(async () => {
                await loadCountryBorders();
                
                // Load radio stations
                await fetchRadioPlaces();
                
                // Load TV channels
                await fetchTVChannels();
                
                updateRadioStatus('online', 'All media loaded');
            }, 1000);
            
            // Fade out loading screen
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.classList.add('fade-out');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 1500);
            }, 4000);

        } catch (error) {
            console.error('Failed to initialize Cesium viewer:', error);
            updateRadioStatus('offline', 'Failed to initialize');
            updateTVStatus('offline', 'Failed to initialize');
        }
    </script>
</body>
</html>